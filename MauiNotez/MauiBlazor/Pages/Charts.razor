@page "/charts"

@using MauiBlazor.Data;
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Calendars
@using Syncfusion.Blazor.Cards
@using Syncfusion.Blazor.Charts
@using TodoSQLite.Data;
@using TodoSQLite.Models;

<SfCard>
    <CardContent>
        <SfDatePicker TValue="DateTime?" Placeholder="From date" CssClass="e-outline" @bind-value="fromDate" FloatLabelType="@FloatLabelType.Always" ShowClearButton="true"></SfDatePicker>
        <SfDatePicker TValue="DateTime?" Placeholder="To date" CssClass="e-outline" @bind-value="toDate" FloatLabelType="@FloatLabelType.Always" ShowClearButton="true"></SfDatePicker>

        <TagSelection @ref="tagSelectionRef" item="null" />

        <SfButton Content="Create graph" IsPrimary="true" OnClick="CreateChartAsync" />
    </CardContent>
</SfCard>

<SfChart>
    <ChartPrimaryXAxis ValueType="Syncfusion.Blazor.Charts.ValueType.Category"></ChartPrimaryXAxis>
    <ChartSeriesCollection>
        <ChartSeries DataSource="@selectedItems" XName="AssignedDate" YName="TransactionAmount" Type="ChartSeriesType.Line">
        </ChartSeries>
    </ChartSeriesCollection>
</SfChart>

@code {
    private TagSelection tagSelectionRef;

    private List<Tag> tags;

    private List<ChipItem> chips = new List<ChipItem>();
    private ChipItem chip { set { chips.Add(value); } }

    private DateTime? fromDate;
    private DateTime? toDate;

    private List<TodoItem> selectedItems = new List<TodoItem>();

    protected override async Task OnInitializedAsync()
    {
        var tagRepo = new TagRepository();
        tags = await tagRepo.GetTagsAsync();

        await base.OnInitializedAsync();
    }

    protected async Task CreateChartAsync()
    {
        var selectedTags = tagSelectionRef.GetSelectedTags();
        var selectedTagIds = selectedTags.Any() ? selectedTags.Select(t => t.ID).ToList() : new List<int>();

        var itemTagRepo = new ItemTagRepository();
        var itemTags = (await itemTagRepo.GetItemTagsAsync()).Where(it => selectedTagIds.Any(t => t == it.TagId)).ToList();

        var itemIds = itemTags.Select(it => it.ItemId).ToList();

        var itemRepo = new TodoItemRepository();
        var items = await itemRepo.GetItemsAsync();

        fromDate = fromDate == null ? DateTime.MinValue : fromDate;
        toDate = toDate == null ? DateTime.MaxValue : toDate;

        selectedItems.Clear();
        selectedItems.AddRange(items.Where(i => i.AssignedDate >= fromDate && i.AssignedDate <= toDate && itemIds.Any(ii => ii == i.ID)));
    }
}
 